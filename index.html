<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id="comments-box" class="comments">
       
      </ul>
      <div class="add-form">
        <input id="name-input"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          value=""
        />
        <textarea id="comment-input"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          value=""
        ></textarea>
        <div class="add-form-row">
          <button id="add-button" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
        //переменные элементов
      const nameInput = document.querySelector('#name-input')
      const commentInput = document.querySelector('#comment-input')
      const addButton = document.querySelector('#add-button')
      const commentsBox = document.querySelector('#comments-box')
      //const currentTime = new Date();
      //const currentDate = `${date.toLocaleDateString('ru-RU', optionsForDate)}.${String(date.getFullYear()).slice(2)} ${fullTime(date.getHours())}:${fullTime(date.getMinutes())}`;
      const renderCommentList = () => {
        const commentsHtml = comments.map((comment, index) => {
              return `<li class="comment">
                    <div class="comment-header">
                      <div>${comments.name}</div>
                      <div>${comments.date}</div>
                    </div>
                    <div class="comment-body">
                      <div data-answer='${index}' class="comment-text">
                        ${(comments.isEdit) ? `<textarea class="comment-edit">${comments.text}</textarea>` : `${comments.text}` }
                      </div>
                      <button id='edit-button' data-index='${index}' class="add-form-button">${comments.isEdit ? `Сохранить` : 'Редактировать'}</button>
                    </div>
                    <div class="comment-footer">
                      <div class="likes">
                        <span class="likes-counter">${comments.likes}</span>
                        <button data-like='${index}' class="like-button ${(comments.isLiked) ? `-active-like` : ''}"></button>
                      </div>
                    </div>
              </li>    
              `
          }).join('')
          

          commentsBox.innerHTML = commentsHtml.replaceAll("→", "<div class='quote'>").replaceAll("←", "</div class='quote'>");
          

          initLikeButtonsListeners();
          //initEditButtonsListeners();
          initCommentAnswerListeners();
      }
      function getCommentList(){
  const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/uliana-ustinova/comments", {
  method: "GET"
});

fetchPromise.then((response) => {
const jsonPromise = response.json();

// Подписываемся на результат преобразования
jsonPromise.then((responseData) => {
console.log (responseData);
const appComments= responseData.comments.map((comment) =>{
return{
  date:`${(new Date(comment.date).getDate().toString().padStart(2, "0")) + "." + (new Date(comment.date).getMonth() + 1).toString().padStart(2, "0") + "." + (new Date(comment.date).getFullYear() - 2000) + " " + (new Date(comment.date).getHours().toString().padStart(2, "0")) + ":" + (new Date(comment.date).getMinutes().toString().padStart(2, "0"))}` ,
likes:comment.likes,
isLiked: false,
text: comment.text,
name: comment.author.name,

    };
  });
comments= appComments;
renderCommentList();
  });
   });
}
getCommentList()

let comments =[]

const Sendingcomment = ()=>{
        const sanitizeHtml= (htmlString)=>{
        return htmlString
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
        };
        getCommentList();
        function addComment() {

          const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/uliana-ustinova/comments", {
  method: "POST",
  body: JSON.stringify({
  date: new Date(),
  likes:0,
  isLiked: false,
  text: sanitizeHtml(commentInput.value),
  name: sanitizeHtml(nameInput.value),
  }),
}).then((response)=>{
  response.join().then((responseData)=>{
    getCommentList();
  });
});
renderCommentList();

      }
      addComment();
      nameInput.value="";
      commentInput.value="";
      } 
      
      addComment();
      // переводим список комментов в массив
      //const commentsList = [
         // {
            // userName: 'Глеб Фокин',
             //currDate: '12.02.22 12:18',
             // likeCounter: 3,
             //isLike: false,
             //commentText: 'Это будет первый комментарий на этой странице',
             // isEdit: false,
        // } ,
         // {
              //userName: 'Варвара Н.',
              //currDate: '13.02.22 19:22',
              //likeCounter: 75,
              //isLike: false,
              //commentText: 'Мне нравится как оформлена эта страница! ❤',
             // isEdit: false,
         // }
    //  ]


      //ВСЕ ЧТО СВЯЗАНО С РЕНДЕРОМ И СОЗДАНИЕМ КОЛЛЕКЦИЙ В ДИНАМИЧЕСКИХ ЭЛЕМЕНТАХ

      // рендерим наш массив в HTML
     
      // Функция создания ответа на комментарий
      const initCommentAnswerListeners = () => {
        const commentAnswer = document.querySelectorAll(".comment-text") 
          commentAnswer.forEach((answer, index) => {
              answer.addEventListener('click', () => {
                if(answer.children.length == 0) { //Дополнительная проверка, чтоб не отрабатывал клик на редактируемый комментарий
                  commentInput.value = `→${comments[index].userName}

${comments[index].commentText}←
`
                }
              })
          })
      }


      // Функция создания коллекции и навешивания ивентов на все кнопки Like
      const initLikeButtonsListeners = () => {
          const likeButtons = document.querySelectorAll('.like-button')
          likeButtons.forEach((likeButton, index) => {
              likeButton.addEventListener('click', () => {
                  if (comments[index].isLiked === false ) {
                      comments[index].isLiked = true;
                      comments[index].likeCounter += 1
                  } else {
                      comments[index].isLiked = false;
                      comments[index].likeCounter -= 1
                      
                  }

                  renderCommentList()
              })
          })
      }
      //Функция создания коллекции и навешивания ивентов на все кнопки РЕДАКТИРОВАТЬ и СОХРАНИТЬ
      //Так же логика измений кнопки с РЕДАКТИРОВАТЬ на СОХРАНИТЬ и обратно
      //const initEditButtonsListeners = () => {
          //const editButtons = document.querySelectorAll('.add-form-button')
          //editButtons.forEach((editButton, index) => {
             // editButton.addEventListener('click', () => {
                //  const editCommentText = document.querySelector('.comment-edit')
                //if (comments[index].isEdit) {           
                 // if (!editCommentText.value == '') {
                    //  comments[index].isEdit = false
                    //  comments[index].commentText = editCommentText.value
                 // } else {
                  //    comments[index].isEdit = false
                  //    comments[index].commentText = "Комментарий не может быть пустым"
                //  }
              //  } else {            
                 // comments[index].isEdit = true
              //  }
                
             //   renderCommentList();
          //    })
       //   })
     // }

      //РЕНДЕРИМ НАШ СПИСОК КОММЕНТАРИЕВ
      renderCommentList();


      //ВСЕ ОСТАЛЬНЫЕ ФУНКЦИИ НА СТАТИЧЕСКИХ ЭЛЕМЕНТАХ

      // Выключение кнопки при не соблюдении условий
      function disableBtn() {
          if (!nameInput.value == '' && !commentInput.value == '') {
              addButton.classList.remove('add-form-button_disable')
          } else {
              addButton.classList.add('add-form-button_disable')
          }
      }

      // функция подправки времени.
      function fullTime(number) {
          if (String(number).length < 2) {
            return number = `0${number}`
          } else {
            return number = number
          }
      }
 // Перекрашиваем поле и включаем/отлючаем кнопку в инпуте имени
 nameInput.addEventListener('input', () => {
          disableBtn()
          nameInput.classList.remove('add-form-name_error')
      })

      nameInput.addEventListener('blur', () => {
          if (nameInput.value == '') {
              nameInput.classList.add('add-form-name_error')
          } else {
              nameInput.classList.remove('add-form-name_error')
          }
      })

      // Перекрашиваем поле и включаем/отлючаем кнопку в инпуте комментариев
      commentInput.addEventListener('input', () => {
          disableBtn()
          commentInput.classList.remove('add-form-comment_error')
      })

      commentInput.addEventListener('blur', () => {
          if (commentInput.value == '') {
              commentInput.classList.add('add-form-comment_error')
          } else {
              commentInput.classList.remove('add-form-comment_error')
          }
      })

      //логика кнопки добавления комментария
      addButton.addEventListener('click', () => {
          addComment()
          renderCommentList()
          nameInput.value = ''
          commentInput.value = ''
          addButton.classList.add('add-form-button_disable')
      })

     

     
      

     
  </script>
</html>
